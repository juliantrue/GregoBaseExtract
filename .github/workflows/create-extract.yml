name: Create Extract

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-extract:
    name: Create Extract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout gregorio-project/GregoBase (HTTPS via GITHUB_TOKEN)
        uses: actions/checkout@v4
        with:
          repository: gregorio-project/GregoBase
          path: GregoBase
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Record GregoBase commit SHA
        id: gregobase_sha
        shell: bash
        run: |
          set -euo pipefail
          echo "sha=$(git -C GregoBase rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Copy gregobase_online.sql into raw/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p raw
          # Try to locate the SQL file within the cloned GregoBase repo
          SQL_PATH=$(find GregoBase -type f -name 'gregobase_online.sql' -print -quit)
          if [[ -z "${SQL_PATH}" ]]; then
            echo "Could not find gregobase_online.sql in GregoBase repo" >&2
            exit 1
          fi
          echo "Found SQL at: ${SQL_PATH}"
          cp -v "${SQL_PATH}" raw/gregobase_online.sql

      - name: Compare checksum with repo
        id: checksum_diff
        shell: bash
        run: |
          set -euo pipefail
          new_sum=$(sha256sum raw/gregobase_online.sql | awk '{print $1}')
          if [[ -f GREGOBASE_CHECKSUM ]]; then
            old_sum=$(cat GREGOBASE_CHECKSUM)
          else
            old_sum=""
          fi
          echo "new=${new_sum}" >> "$GITHUB_OUTPUT"
          if [[ "${new_sum}" == "${old_sum}" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Checksum unchanged (${new_sum}). No extract update required."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Checksum changed: old='${old_sum}' new='${new_sum}'. Proceeding with extract."
          fi

      - name: Write GREGOBASE_CHECKSUM (SHA-256)
        if: steps.checksum_diff.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          printf "%s\n" "${{ steps.checksum_diff.outputs.new }}" > GREGOBASE_CHECKSUM
          echo "GREGOBASE_CHECKSUM=${{ steps.checksum_diff.outputs.new }}"

      - name: Run extraction scripts
        if: steps.checksum_diff.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p extract/csv extract/jsonl
          python3 --version
          # Extract CSVs from the SQL dump
          python3 scripts/extract_tables.py -i raw/gregobase_online.sql -o extract/csv
          # Build unified chants JSONL (gzip and remove uncompressed file)
          python3 scripts/unify_chants.py --output extract/jsonl/chants.jsonl --gzip --rm

      - name: Create Pull Request
        if: steps.checksum_diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update extract from latest GregoBase"
          title: "Update Extract from GregoBase ${{ steps.gregobase_sha.outputs.sha }}"
          body: "Create extract for GregoBase ${{ steps.gregobase_sha.outputs.sha }}"
          branch: chore/update-extract
          delete-branch: true
          add-paths: |
            raw/gregobase_online.sql
            GREGOBASE_CHECKSUM
            extract/**
